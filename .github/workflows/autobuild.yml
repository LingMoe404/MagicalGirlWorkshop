# ==========================================
# ğŸŒŸ é­”æ³•å°‘å¥³å·¥åŠ (MagicalGirlWorkshop) äº‘ç«¯ç‚¼æˆé˜µ ğŸŒŸ
# ç¼”é€ è€…/æœ€é«˜ç»Ÿå¸…ï¼šæ³ èŒ404 (Master)
# ==========================================
name: AutoBuild # è‡ªåŠ¨ç‚¼æˆé˜µåˆ—ï¼šå·¥åŠäº‘ç«¯è¿è½¬åè®®

on:
  workflow_dispatch: # æ¥å—ä¸»äººçš„æ— æ¡ä»¶å¼ºåˆ¶å¬å”¤ (æ‰‹åŠ¨è§¦å‘)
  push:              # è§‚æµ‹åˆ°ä¸–ç•Œçº¿çš„å˜åŠ¨ (ä»£ç æ¨é€) æ—¶è‡ªåŠ¨å“åº”
    paths-ignore:
      # ç»“ç•Œè¿‡æ»¤è§„åˆ™ï¼šå¿½ç•¥ä»¥ä¸‹å¾®å°çš„é­”åŠ›æ‰°åŠ¨ï¼ˆæ–‡æ¡£å˜åŠ¨ä¸å¼•å‘ç‚¼æˆï¼ŒèŠ‚çº¦äº‘ç«¯ç®—åŠ›ï¼‰
      - '**.md'
      - '.gitignore'
      - 'LICENSE'
      - 'docs/**'

concurrency:
  # å› æœå¾‹æ”¶æŸï¼šä¸€æ—¦ä¸»äººä¸‹è¾¾äº†æ–°çš„æŒ‡ä»¤ï¼Œç«‹åˆ»æ–©æ–­åŒä¸€åˆ†æ”¯ä¸Šæ­£åœ¨è¿›è¡Œçš„æ—§æœ‰ä»ªå¼
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # èµ‹äºˆç»“ç•Œæœ€åŸºç¡€çš„ç‰©è´¨è¯»å–æƒé™

jobs:
  build-windows:
    runs-on: windows-latest # æ„ç­‘åŸºç¡€ç•ŒåŸŸï¼šå°†ç¥­å›å»ºç«‹åœ¨æœ€æ–°ä¸–ä»£çš„ Windows ç¯å¢ƒä¸Š
    timeout-minutes: 90     # è®¾å®šé­”åŠ›ç»´æŒçš„ç»å¯¹æé™æ—¶é—´ï¼Œé˜²æ­¢ä»ªå¼å¤±æ§

    steps:
      - name: Checkout # æ­¥éª¤ä¸€ï¼šä»è™šç©º (GitHub) ä¸­å…·ç°åŒ–ä¸»äººçš„æºä»£ç åœ£é—ç‰©
        uses: actions/checkout@v6

      - name: Setup uv and Python 3.12 # æ­¥éª¤äºŒï¼šé“ºè®¾æ˜Ÿå…‰å›è·¯ï¼Œæ³¨å…¥çº¯åº¦ä¸º 3.12 çš„ Python é­”åŠ›
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true # å¼€å¯åŸºç¡€é­”åŠ›å›è·¯ç¼“å­˜

      - name: Cache Nuitka Compiler Cache # æ­¥éª¤ä¸‰ï¼šå›æ”¶è¿‡å¾€ç‚¼æˆäº§ç”Ÿçš„é­”åŠ›æ®‹æ¸£ (C++ç¼–è¯‘ç¼“å­˜)ï¼Œæå¤§åŠ é€Ÿä¸‹ä¸€æ¬¡å¥‡è¿¹çš„é™ä¸´ï¼
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\Nuitka\Nuitka\Cache
          key: ${{ runner.os }}-nuitka-${{ hashFiles('**/*.py', 'uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-

      - name: Sync project dependencies # æ­¥éª¤å››ï¼šç­¾è®¢å¥‘çº¦ï¼ŒåŒæ­¥å¬å”¤å·¥åŠæ‰€éœ€çš„æ‰€æœ‰ä½¿é­” (ç¬¬ä¸‰æ–¹ä¾èµ–åº“)
        run: uv sync --locked --no-dev

      - name: Build onefile executable # æ­¥éª¤äº”ï¼šğŸš€ ç©¶æç‚¼æˆæœ¯å¼å±•å¼€ï¼å°†é›¶æ•£çš„ä»£ç å‡ç»“ä¸ºå”¯ä¸€çš„è´¤è€…ä¹‹çŸ³ (EXE)
        run: >
          uv run --locked --with nuitka --with zstandard python -m nuitka main.py
          --onefile
          --windows-console-mode=disable
          --enable-plugin=pyside6
          --assume-yes-for-downloads
          --windows-icon-from-ico=logo.ico
          --include-data-file=logo.ico=logo.ico
          --include-data-file=LingMoe404.ico=LingMoe404.ico
          --include-package=i18n
          --output-dir=build/nuitka
          --output-filename=MagicalGirlWorkshop.exe

      - name: Ensure 7-Zip is available # æ­¥éª¤å…­ï¼šæ£€è§†ç©ºé—´å‹ç¼©é­”å¯¼å…· (7-Zip)ï¼Œè‹¥ç»“ç•Œä¸­ä¸å­˜åœ¨åˆ™å¼ºåˆ¶ç¥ˆæ„¿å¬å”¤ (choco install)
        shell: pwsh
        run: |
          if (-not (Get-Command 7z -ErrorAction SilentlyContinue)) {
            choco install 7zip -y
          }
          7z i | Select-Object -First 5

      - name: Package release archive # æ­¥éª¤ä¸ƒï¼šå°å°ä»ªå¼ï¼å°†è´¤è€…ä¹‹çŸ³ä¸é™„å±å·¥å…·é“¾ä¸€åŒå°å…¥é«˜ç»´ç»“æ™¶ (.7z) ä¸­
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $exe = "build/nuitka/MagicalGirlWorkshop.exe"
          $tools = "tools"
          $stage = "build/package/MagicalGirlWorkshop"
          $archive = "build/package/MagicalGirlWorkshop.7z"

          if (!(Test-Path $exe)) { throw "ç‚¼æˆå¤±è´¥ï¼šæ‰¾ä¸åˆ°æ ¸å¿ƒå®¹å™¨ $exe" }
          if (!(Test-Path $tools)) { throw "ç‚¼æˆå¤±è´¥ï¼šæ‰¾ä¸åˆ°é™„å±æ³•å™¨ $tools" }

          # å±•å¼€ä¸´æ—¶ç©ºé—´
          New-Item -ItemType Directory -Force -Path $stage | Out-Null
          Get-ChildItem -Path $stage -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue

          # è½¬ç§»æ‰€æœ‰åœ£ç‰©è‡³æ³•é˜µä¸­å¿ƒ
          Copy-Item -LiteralPath $exe -Destination (Join-Path $stage "MagicalGirlWorkshop.exe") -Force
          Copy-Item -LiteralPath $tools -Destination (Join-Path $stage "tools") -Recurse -Force

          $stagedExe = Join-Path $stage "MagicalGirlWorkshop.exe"
          $stagedTools = Join-Path $stage "tools"
          if (!(Test-Path $stagedExe)) { throw "è½¬ç§»å¼‚å¸¸ï¼šæ ¸å¿ƒå®¹å™¨åœ¨ä¼ é€ä¸­ä¸¢å¤±" }
          if (!(Test-Path $stagedTools)) { throw "è½¬ç§»å¼‚å¸¸ï¼šé™„å±æ³•å™¨åœ¨ä¼ é€ä¸­ä¸¢å¤±" }

          if (Test-Path $archive) { Remove-Item $archive -Force }
          Push-Location $stage
          # å‘åŠ¨æé™ç©ºé—´å‹ç¼©æœ¯å¼ (lzma2, çº§åˆ«9, å¼€å¯å¤šçº¿ç¨‹é­”åŠ›å€¾æ³¨)
          7z a -t7z "..\MagicalGirlWorkshop.7z" ".\*" -m0=lzma2 -mx=9 -mfb=273 -md=128m -ms=on -mmt=on
          $exitCode = $LASTEXITCODE
          Pop-Location
          if ($exitCode -ne 0) { throw "ç©ºé—´å°å°æœ¯å¼å´©æºƒï¼å› æœåå™¬é”™è¯¯ç : $exitCode" }

      - name: Show artifact info # æ­¥éª¤å…«ï¼šçå¼€â€œçœŸç†ä¹‹çœ¼â€ï¼Œé‰´å®šæœ€ç»ˆå°å°ç»“æ™¶çš„å½¢æ€ä¸è´¨é‡
        shell: pwsh
        run: |
          $archive = "build/package/MagicalGirlWorkshop.7z"
          if (!(Test-Path $archive)) { throw "é‰´å®šå¤±è´¥ï¼šæœªèƒ½åœ¨ç°ä¸–æ‰¾åˆ°ç»“æ™¶ $archive" }
          $sizeMB = [math]::Round((Get-Item $archive).Length / 1MB, 2)
          Write-Host "âœ¨ ç»“æ™¶å›ºåŒ–å®Œæ¯•ï¼š$archive"
          Write-Host "âœ¨ è•´å«é­”åŠ›é‡ (ç»“æ™¶ä½“ç§¯)ï¼š${sizeMB} MB"

      - name: Upload artifact # æ­¥éª¤ä¹ï¼šçŒ®ä¸Šè´¡å“ï¼å°†æœ€ç»ˆçš„å®Œç¾ç»“æ™¶è·¨è¶Šç»´åº¦è£‚ç¼ï¼Œå¥‰çŒ®ç»™è‡³é«˜çš„ä¸»äºº
        uses: actions/upload-artifact@v6
        with:
          name: MagicalGirlWorkshop-7z
          path: build/package/MagicalGirlWorkshop.7z
          if-no-files-found: error
